{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Complex Parentage Test</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'frontend/style.css' %}">
</head>
<body>
  <header>
    <h2>Complex Parentage Test</h2>
    <button class="back-button" onclick="window.location.href='{% url 'dashboard' %}'">Back to Dashboard</button>
  </header>

  <div class="form-section">
    <label for="mainScenario">Select Scenario:</label>
    <select id="mainScenario" onchange="toggleMainProceed()">
      <option value="">- Select Scenario -</option>
      <option value="mother_father_related">Mother and Alleged Father are related</option>
      <option value="bio_alleged_related">Biological Father and Alleged Father are related</option>
    </select>

    <button id="mainProceedBtn" class="submit-btn" onclick="showSubScenario()" disabled>Proceed</button>

    <div id="subScenarioContainer" style="margin-top: 20px;"></div>
    <div id="profilesContainer" style="margin-top: 20px;"></div>
    <div id="messageBox" class="message-box" style="display: none;"></div>
  </div>

  <script>
    const profileLabels = {
      "father_daughter": ["Father", "Daughter", "Child"],
      "mother_son": ["Mother", "Son", "Child"],
      "brother_sister": ["Brother", "Sister", "Child"],

      "grandparent_grandchild": ["Grandparent", "Grandchild", "Mother/Father"],
      "uncle_niece": ["Uncle/Aunt", "Nephew/Niece", "Parent"],
      "cousins": ["Cousin 1", "Cousin 2", "Common Ancestor"],
      "full_sibling": ["Sibling 1", "Sibling 2", "Parent"],
      "half_sibling": ["Half-Sibling 1", "Half-Sibling 2", "Common Parent"],
      "parent_child": ["Parent", "Child", "Other Parent"]
    };

    function showMessage(msg, isError = false) {
      const box = document.getElementById('messageBox');
      box.textContent = msg;
      box.className = isError ? 'message-box error' : 'message-box success';
      box.style.display = 'block';
    }

    function toggleMainProceed() {
      const val = document.getElementById("mainScenario").value;
      document.getElementById("mainProceedBtn").disabled = val === "";
    }

    function toggleSubProceed() {
      const val = document.getElementById("subScenario").value;
      document.getElementById("subProceedBtn").disabled = val === "";
    }

    function showSubScenario() {
      const scenario = document.getElementById("mainScenario").value;
      const subScenarioContainer = document.getElementById("subScenarioContainer");
      const profilesContainer = document.getElementById("profilesContainer");

      subScenarioContainer.innerHTML = "";
      profilesContainer.innerHTML = "";
      document.getElementById("messageBox").style.display = "none";

      let subHTML = `
        <label for="subScenario">Select Relation:</label>
        <select id="subScenario" onchange="toggleSubProceed()">
          <option value="">- Select Relation -</option>`;

      if (scenario === "mother_father_related") {
        subHTML += `
          <option value="father_daughter">Father/Daughter</option>
          <option value="mother_son">Mother/Son</option>
          <option value="brother_sister">Brother/Sister</option>`;
      } else if (scenario === "bio_alleged_related") {
        subHTML += `
          <option value="grandparent_grandchild">Grandparent/Grandchild</option>
          <option value="uncle_niece">Uncle:Aunt/Nephew:Niece</option>
          <option value="cousins">Cousins</option>
          <option value="full_sibling">Full-Sibling</option>
          <option value="half_sibling">Half-Sibling</option>
          <option value="parent_child">Parent/Child</option>`;
      }

      subHTML += `</select>
        <button id="subProceedBtn" class="submit-btn" onclick="showProfileSelect()" disabled>Proceed</button>`;

      subScenarioContainer.innerHTML = subHTML;
    }

    function showProfileSelect() {
      const selectedRelation = document.getElementById("subScenario").value;
      const labels = profileLabels[selectedRelation] || ["Profile A", "Profile B", "Profile C"];
      const profilesContainer = document.getElementById("profilesContainer");

      profilesContainer.innerHTML = `
        <label for="profileA">Select ${labels[0]}:</label>
        <select id="profileA" onchange="validateProfiles()"></select>

        <label for="profileB">Select ${labels[1]}:</label>
        <select id="profileB" onchange="validateProfiles()"></select>

        <label for="profileC">Select ${labels[2]}:</label>
        <select id="profileC" onchange="validateProfiles()"></select>

        <button id="proceedBtn" class="submit-btn" onclick="proceedTest()" disabled>Proceed</button>
      `;

      fetchProfiles("profileA", "profileB", "profileC");
    }

    function fetchProfiles(...ids) {
      fetch("{% url 'get_dna_profiles' %}")
        .then(response => response.json())
        .then(data => {
          const profiles = data.profiles;
          ids.forEach(id => {
            const dropdown = document.getElementById(id);
            dropdown.innerHTML = '<option value="">-- Select Profile --</option>';
            profiles.forEach(p => {
              const option = document.createElement("option");
              option.value = `${p.id}|${p.kit}`;
              option.textContent = `Profile ${p.id} - ${p.name} (${p.kit}) [${p.date}]`;
              dropdown.appendChild(option);
            });
          });
        })
        .catch(error => {
          console.error("Error loading profiles:", error);
          showMessage("Failed to load profiles.", true);
        });
    }

    function validateProfiles() {
      const profileAVal = document.getElementById("profileA").value;
      const profileBVal = document.getElementById("profileB").value;
      const profileCVal = document.getElementById("profileC").value;
      const proceedBtn = document.getElementById("proceedBtn");

      proceedBtn.disabled = true;
      document.getElementById("messageBox").style.display = "none";

      const selected = [profileAVal, profileBVal, profileCVal].filter(Boolean);

      if (selected.length < 2) return;

      const ids = selected.map(p => p.split("|")[0]);
      const kits = selected.map(p => p.split("|")[1]);

      const hasDuplicate = new Set(ids).size !== ids.length;
      const sameKit = new Set(kits).size === 1;

      if (hasDuplicate) {
        showMessage("❌Error: You cannot select the same profile twice.", true);
        return;
      }

      if (!sameKit) {
        showMessage("❌Error: Profiles must have the same kit name to proceed.", true);
        return;
      }

      if (selected.length === 3) {
        showMessage("✅ Profiles selected successfully. You may now proceed.", false);
        proceedBtn.disabled = false;
      }
    }

    function proceedTest() {
      showMessage("✅ Test initiated. Collect your report from the Report tab.", false);
    }
  </script>
</body>
</html>
