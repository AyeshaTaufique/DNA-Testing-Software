{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Add Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'frontend/style.css' %}">
  <style>
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 5px;
      border: 1px solid #b2f0f0;
      background-color: #f4fdfc;
    }

    input.invalid {
      border: 2px solid #ff0033;
      background-color: #ffecec;
    }

    input.valid {
      border: 2px solid #28a745;
      background-color: #eaffea;
    }

    .message-box {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #ffffff;
      color: #00b8b8;
      border: 1px solid #00b8b8;
      padding: 20px 30px;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 8px 20px rgba(0, 180, 180, 0.2);
      z-index: 999;
      display: none;
    }

    .error {
      background-color: #ffe3e3;
      color: #ff0033;
      border: 1px solid #ff0033;
    }
  </style>
</head>

<body>
  <header>
    <h2>Add Profile</h2>
    <button class="back-button" onclick="window.location.href='{% url 'dashboard' %}'">Back to Dashboard</button>
  </header>

  <div class="form-section">
    <label for="kitSelect">Select Kit</label>
    <select id="kitSelect" onchange="handleKitSelection()">
      <option value="">-- Select a Kit --</option>
      <option value="GlobalFiler">GlobalFiler</option>
      <option value="AmpFlSTR Identifiler">AmpFlSTR Identifiler</option>
      <option value="PowerPlex Fusion System">PowerPlex Fusion System</option>
      <option value="PowerPlex Fusion 6C System">PowerPlex Fusion 6C System</option>
      <option value="PowerPlex 21 System">PowerPlex 21 System</option>
    </select>

    <label>Name</label>
    <input type="text" id="name" placeholder="Enter name" />

    <label>Date</label>
    <input type="date" id="date" />

    <div id="lociTable"></div>
    <button class="submit-btn" onclick="saveProfile()">Save Profile</button>
  </div>

  <div id="messageBox" class="message-box"></div>

  <script>
    const lociMap = {
      "GlobalFiler": {
        "D3S1358": [10, 17], "vWA": [14, 23], "D16S539": [6, 15], "CSF1PO": [6, 13], "TPOX": [6, 11], "D8S1179": [7, 16],
        "D21S11": [24, 33], "D18S51": [9, 25], "DYS391": [8, 12], "D2S441": [7, 14], "D19S433": [8, 18], "TH01": [5, 11],
        "FGA": [17, 27], "D22S1045": [9, 15], "D5S818": [8, 16], "D13S317": [6, 13], "D7S820": [6, 14], "SE33": [10, 40],
        "D10S1248": [12, 16], "D1S1656": [10, 20], "D12S391": [9, 17], "D2S1338": [17, 24]
      },
      "AmpFlSTR Identifiler": {
        "D8S1179": [7, 16], "D21S11": [24, 33], "D7S820": [6, 14], "CSF1PO": [6, 13], "D3S1358": [10, 17], "TH01": [5, 11],
        "D13S317": [6, 13], "D16S539": [6, 15], "D2S1338": [17, 24], "D19S433": [8, 18], "vWA": [14, 23], "TPOX": [6, 11],
        "D18S51": [9, 25], "D5S818": [8, 16], "FGA": [17, 27]
      },
      "PowerPlex Fusion System": {
        "D3S1358": [10, 17], "D1S1656": [10, 20], "D2S441": [7, 14], "D10S1248": [12, 16], "D13S317": [6, 13],
        "D16S539": [6, 15], "D18S51": [9, 25], "D2S1338": [17, 24], "CSF1PO": [6, 13], "TH01": [5, 11], "vWA": [14, 23],
        "D21S11": [24, 33], "D7S820": [6, 14], "D5S818": [8, 16], "TPOX": [6, 11], "D8S1179": [7, 16],
        "D12S391": [9, 17], "D19S433": [8, 18], "FGA": [17, 27]
      },
      "PowerPlex Fusion 6C System": {
        "D1S1656": [10, 20], "D2S1338": [17, 24], "D2S441": [7, 14], "D3S1358": [10, 17], "D5S818": [8, 16],
        "D7S820": [6, 14], "D8S1179": [7, 16], "D10S1248": [12, 16], "D12S391": [9, 17], "D13S317": [6, 13],
        "D16S539": [6, 15], "D18S51": [9, 25], "D19S433": [8, 18], "D21S11": [24, 33], "D22S1045": [9, 15],
        "CSF1PO": [6, 13], "FGA": [17, 27], "TH01": [5, 11], "vWA": [14, 23], "TPOX": [6, 11]
      },
      "PowerPlex 21 System": {
        "D1S1656": [10, 20], "D2S1338": [17, 24], "D3S1358": [10, 17], "D5S818": [8, 16], "D7S820": [6, 14],
        "D8S1179": [7, 16], "D12S391": [9, 17], "D13S317": [6, 13], "D16S539": [6, 15], "D18S51": [9, 25],
        "D19S433": [8, 18], "D21S11": [24, 33], "CSF1PO": [6, 13], "FGA": [17, 27], "TH01": [5, 11],
        "TPOX": [6, 11], "vWA": [14, 23]
      }
    };

    function handleKitSelection() {
      const kit = document.getElementById("kitSelect").value;
      const dateField = document.getElementById("date");
      if (kit) {
        dateField.valueAsDate = new Date();
        generateLociTable(kit);
      } else {
        document.getElementById("lociTable").innerHTML = "";
      }
    }

    function generateLociTable(kitKey) {
        const container = document.getElementById("lociTable");
        const loci = lociMap[kitKey];
        let html = `<table><tr><th>Locus</th><th>Allele 1</th><th>Allele 2</th></tr>`;
        Object.entries(loci).forEach(([locus, range], index) => {
          const placeholder = `${range[0]}â€“${range[1]}`;
          html += `<tr>
            <td>${locus}</td>
            <td><input type="text" name="allele1_${index}"
              data-locus="${locus}" data-min="${range[0]}" data-max="${range[1]}"
              placeholder="${placeholder}" title="Allowed: ${placeholder}" oninput="validateAllele(this)" /></td>
            <td><input type="text" name="allele2_${index}"
              data-locus="${locus}" data-min="${range[0]}" data-max="${range[1]}"
              placeholder="${placeholder}" title="Allowed: ${placeholder}" oninput="validateAllele(this)" /></td>
          </tr>`;
        });
        html += "</table>";
        container.innerHTML = html;
      }


    function validateAllele(el) {
      const val = el.value.trim();
      const min = parseFloat(el.dataset.min);
      const max = parseFloat(el.dataset.max);

      if (!val) {
        el.classList.remove("invalid", "valid");
        return;
      }

      const num = parseFloat(val);
      if (isNaN(num) || num < min || num > max) {
        el.classList.add("invalid");
        el.classList.remove("valid");
      } else {
        el.classList.remove("invalid");
        el.classList.add("valid");
      }
    }

    function saveProfile() {
      const name = document.getElementById("name").value.trim();
      const date = document.getElementById("date").value;
      const kit = document.getElementById("kitSelect").value;

      if (!kit) return showMessage("Please select a kit.", true);
      if (!name) return showMessage("Please enter a name.", true);
      if (!date) return showMessage("Please enter a valid date.", true);

      const loci = lociMap[kit];
      const alleles = [];
      const locusKeys = Object.keys(loci);

      for (let i = 0; i < locusKeys.length; i++) {
        const locus = locusKeys[i];
        const range = loci[locus];
        const allele1Field = document.querySelector(`input[name="allele1_${i}"]`);
        const allele2Field = document.querySelector(`input[name="allele2_${i}"]`);

        const allele1 = allele1Field.value.trim();
        const allele2 = allele2Field.value.trim();

        const a1 = parseFloat(allele1);
        const a2 = parseFloat(allele2);

        if (!allele1 || !allele2 || isNaN(a1) || isNaN(a2) || a1 < range[0] || a1 > range[1] || a2 < range[0] || a2 > range[1]) {
          allele1Field.classList.add("invalid");
          allele2Field.classList.add("invalid");
          showMessage(`Alleles for ${locus} must be between ${range[0]} and ${range[1]}.`, true);
          return;
        } else {
          allele1Field.classList.remove("invalid");
          allele2Field.classList.remove("invalid");
        }

        alleles.push({ locus: locus, allele1: allele1, allele2: allele2 });
      }

      fetch("{% url 'save_profile' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          name: name,
          date: date,
          kit: kit,
          alleles: alleles
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            showMessage("Profile saved successfully.");
            setTimeout(() => location.reload(), 3000);
          } else {
            showMessage(data.message || "Error saving profile.", true);
          }
        })
        .catch(error => {
          showMessage("Request failed: " + error, true);
        });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showMessage(msg, isError = false) {
      const box = document.getElementById("messageBox");
      box.textContent = msg;
      box.className = isError ? "message-box error" : "message-box";
      box.style.display = "block";
      setTimeout(() => (box.style.display = "none"), 3000);
    }
  </script>
</body>

</html>
